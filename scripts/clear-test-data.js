#!/usr/bin/env node

/**
 * ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
 * E2Eãƒ†ã‚¹ãƒˆå‰ã«libraryãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹
 */

import { config } from 'dotenv';
import { sql } from 'drizzle-orm';
import { drizzle } from 'drizzle-orm/node-postgres';
import { Client } from 'pg';

// ç’°å¢ƒå¤‰æ•°ã‚’èª­ã¿è¾¼ã¿
config();

const TEST_DB_NAME = process.env.POSTGRES_TEST_DB || 'apps_script_hub_test_db';
const POSTGRES_CONFIG = {
  host: 'localhost',
  port: 5433,
  user: process.env.POSTGRES_USER,
  password: process.env.POSTGRES_PASSWORD,
  database: TEST_DB_NAME,
};

async function clearTestData() {
  console.log('ğŸ§¹ ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ä¸­...');

  const client = new Client(POSTGRES_CONFIG);
  
  try {
    await client.connect();
    const db = drizzle(client);

    // libraryãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢
    await db.execute(sql`DELETE FROM "library"`);
    console.log('âœ… libraryãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');

  } catch (error) {
    console.error('âŒ ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢ã‚¨ãƒ©ãƒ¼:', error);
    throw error;
  } finally {
    await client.end();
  }
}

async function main() {
  try {
    await clearTestData();
    process.exit(0);
  } catch (error) {
    console.error('âŒ ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
    process.exit(1);
  }
}

// ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒç›´æ¥å®Ÿè¡Œã•ã‚ŒãŸå ´åˆã®ã¿å®Ÿè¡Œ
if (import.meta.url === `file://${process.argv[1]}`) {
  main();
}

export { clearTestData };